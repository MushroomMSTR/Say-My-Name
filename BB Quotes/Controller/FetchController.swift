//
//  FetchController.swift
//  BB Quotes
//
//  Created by NazarStf on 18.07.2023.
//

import Foundation

struct FetchController {
	enum NetworkError: Error {
		case badURL, badResponse
	}
	
	// https://breaking-bad-api-six.vercel.app/api/quotes/random?production=Breaking+Bad
	
	private let baseURL = URL(string: "https://breaking-bad-api-six.vercel.app/api")!
	
	func fetchQuote(from show: String) async throws -> Quote {
		let quoteURL = baseURL.appending(path: "quotes/random")
		var quoteComponents = URLComponents(url: quoteURL, resolvingAgainstBaseURL: true)
		let quoteQueryItem = URLQueryItem(name: "production", value: show.replaceSpaceWithPlus)
		
		quoteComponents?.queryItems = [quoteQueryItem]
		
		guard let fetchURL = quoteComponents?.url else {
			throw NetworkError.badURL
		}
		
		let (data, responce) = try await URLSession.shared.data(from: fetchURL)
		
		guard let responce = responce as? HTTPURLResponse, responce.statusCode == 200 else {
			throw NetworkError.badResponse
		}
		
		let quote = try JSONDecoder().decode(Quote.self, from: data)
		
		return quote
	}
	
	// https://breaking-bad-api-six.vercel.app/api/characters?name=Walter+White
	
	func fetchCharacter(_ name: String) async throws -> Character {
		let characterURL = baseURL.appending(path: "characters")
		var characterComponents = URLComponents(url: characterURL, resolvingAgainstBaseURL: true)
		let characterQueryItem = URLQueryItem(name: "name", value: name.replaceSpaceWithPlus)
		characterComponents?.queryItems = [characterQueryItem]
		
		guard let fetchURL = characterComponents?.url else {
			throw NetworkError.badURL
		}
		
		let (data, responce) = try await URLSession.shared.data(from: fetchURL)
		
		guard let responce = responce as? HTTPURLResponse, responce.statusCode == 200 else {
			throw NetworkError.badResponse
		}
		
		let decoder = JSONDecoder()
		decoder.keyDecodingStrategy = .convertFromSnakeCase
		
		let characters = try decoder.decode([Character].self, from: data)
		
		return characters[0]
	}
	
}
